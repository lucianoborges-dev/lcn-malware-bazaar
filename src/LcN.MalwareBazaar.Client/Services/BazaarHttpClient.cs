using LcN.MalwareBazaar.ApiClient.Models;

namespace LcN.MalwareBazaar.ApiClient.Services;

public abstract class BazaarHttpClient
{
    private static readonly HttpClient _client = new();
    private readonly string _apiAddress;

    protected BazaarHttpClient(string apiAddress)
    {
        _apiAddress = apiAddress;
    }

    private async Task<HttpContent> GetContent(Query query, CancellationToken cancellationToken = default)
    {
        var response = await _client.PostAsync(_apiAddress, query, cancellationToken);
        response.EnsureSuccessStatusCode();

        return response.Content;
    }

    protected async Task<string> GetContentString(Query query, CancellationToken cancellationToken = default)
    {
        var content = await GetContent(query, cancellationToken);
        return await content!.ReadAsStringAsync(cancellationToken);
    }

    protected async Task<Stream> GetContentStream(Query query, CancellationToken cancellationToken = default)
    {
        var content = await GetContent(query, cancellationToken);
        return await content!.ReadAsStreamAsync(cancellationToken);
    }
}
